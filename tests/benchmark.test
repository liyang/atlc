#! /bin/sh
# This test checks that a multi-threaded vesion of 
# atlc runs faster than a single threaded one. 
# and reports by how much so. 

if [ "x$mpirun_found" = "xyes" ] ; then
  return 77
else
  cp $top_srcdir/examples/25ohm-401h.bmp $top_builddir/tmp
  ret=`$top_builddir/tests/benchmark $top_builddir/src/non_gui/atlc $top_builddir/tmp/25ohm-401h.bmp `
  rm -f $top_builddir/tmp/25ohm-401h.bmp

#  cp $top_srcdir/examples/twin-wire3.bmp $top_builddir/tmp
#  ret=`$top_builddir/tests/benchmark $top_builddir/src/non_gui/atlc $top_builddir/tmp/twin-wire3.bmp `
#  rm -f $top_builddir/tmp/twin-wire3.bmp

  exitcode=`echo $ret | awk '{print $1}'`
  t1=`echo $ret | awk '{print $2}'`
  t2=`echo $ret | awk '{print $3}'`
  speedup=`echo $ret | awk '{print $4}'`
  N_cpus=`echo $ret | awk '{print $5}'`
  mhz=`echo $ret | awk '{print $6}'`
  efficiency=`echo $ret | awk '{print $7}'`
  cpu_type=`echo $ret | awk '{print $8}'`
  fpu_type=`echo $ret | awk '{print $9}'`
  supported_cpus=`echo $ret | awk '{print $10}'`
  ram=`echo $ret | awk '{print $11}'`
  sysname=`echo $ret | awk '{print $12}'`
  nodename=`echo $ret | awk '{print $13}'`
  release=`echo $ret | awk '{print $14}'`
  version=`echo $ret | awk '{print $15}'`
  machine=`echo $ret | awk '{print $16}'`
  hw_provider=`echo $ret | awk '{print $17}'`
  hw_platform=`echo $ret | awk '{print $18}'`
  L1data=`echo $ret | awk '{print $19}'`
  L1instruction=`echo $ret | awk '{print $20}'`
  L2=`echo $ret | awk '{print $21}'`
  filename=foo
  echo " "
  echo "                  BENCHMARK DATA"
  echo "To get hardware data, atlc MUST be configured with --enable-hardware-info"
  echo "Hardware data working 95% on Solaris, less so on other OS's"
  echo " "
  echo "Hardware provider is $hw_provider. Hardware platform is $hw_platform."
  echo "Hardware provider is $hw_provider. Hardware platform is $hw_platform." >> tests.log
  echo "Hardware provider is $hw_provider. Hardware platform is $hw_platform." >> benchmark.$filename.html
  echo "<STRONG>Hardware provider is $hw_provider. Hardware platform is $hw_platform.</STRONG>" > benchmark.$filename.html
  echo "Machine: $machine. Sysname: $sysname. Release: $release. Nodename: $nodename."
  echo "Machine: $machine. Sysname: $sysname. Release: $release. Nodename: $nodename." >> tests.log
  echo "<BR>Machine: $machine. Sysname: $sysname. Release: $release. Nodename: $nodename." >> benchmark.$filename.html
  echo "Number of CPUs supported by system is $supported_cpus. Number of CPUs online is  $N_cpus."
  echo "Number of CPUs supported by system is $supported_cpus. Number of CPUs online is  $N_cpus." >> tests.html
  echo "<BR>Number of CPUs supported by system is $supported_cpus. Number of CPUs online is  $N_cpus." >> benchmark.$filename.dat
  echo "CPU_type is $cpu_type. FPU_type is $fpu_type. Speed of CPU(s) is $mhz MHz."
  echo "CPU_type is $cpu_type. FPU_type is $fpu_type. Speed of CPU(s) is $mhz MHz." >> tests.log
  echo "<BR>CPU_type is $cpu_type. FPU_type is $fpu_type. Speed of CPU(s) is $mhz MHz." >> benchmark.$filename.html
  echo "RAM is $ram Mb."
  echo "RAM is $ram Mb." >> tests.log
  echo "<BR>RAM is $ram Mb." >> benchmark.$filename.html
  echo "L1 data cache is $L1data; L1 instruction cache is $L1instruction; L2 cache is $L2"
  echo "L1 data cache is $L1data; L1 instruction cache is $L1instruction; L2 cache is $L2" >> tests.log
  echo "<BR>L1 data cache is $L1data; L1 instruction cache is $L1instruction; L2 cache is $L2" >> benchmark.$filename.html
  if [ "x$built_with_posix_threads" = "xyes" ] ; then
    echo "Run times: T_sequential is $t1 s. T_parallel is $t2 s."
    echo "Run times: T_sequential is $t1 s. T_parallel is $t2 s." >> tests.log
    echo "<BR>Run times: T_sequential is $t1 s. T_parallel is $t2 s." >> benchmark.$filename.html
    echo "Speedup=T_sequential/T_parallel is $speedup. Efficiency=Speedup/N_cpus is $efficiency"
    echo "Speedup=T_sequential/T_parallel is $speedup. Efficiency=Speedup/N_cpus is $efficiency" >> tests.log
    echo "<BR>Speedup=T_sequential/T_parallel is $speedup. Efficiency=Speedup/N_cpus is $efficiency" >> benchmark.$filename.html
  else
    echo "Run times: T_sequential is $t1 s. Not configured for parallel operation."
    echo "Run times: T_sequential is $t1 s. Not configured for parallel operation." >> tests.log
    echo "<BR>Run times: T_sequential is $t1 s. Not configured for parallel operation." >> benchmark.$filename.html
  fi 
fi
